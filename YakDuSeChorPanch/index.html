<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      height: 100vh;
      margin: 0;
    }

    .line-container {
      display: flex;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .line-item {
      width: 50px;
      height: 50px;
      border: 1px solid #ccc;
      background-color: #fff; /* Цвет фона ячейки */
      transition: background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .line-item.active {
      background-color: #cccccc; /* Цвет активной ячейки */
    }

    .line-main {
      width: 470px;
      height: 100px;
    }

    .debug {
      width: 470px;
      height: 50px;
      border: 1px solid #ccc;
      background-color: #fff; /* Цвет фона ячейки */
      transition: background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .debug.active {
      background-color: #cccccc; /* Цвет активной ячейки */
    }
  </style>
</head>
<body>

<div class="line-main">
  <div class="debug" id="debug-box"></div>
  <div class="line-container" id="line"></div>
  <form id="speedForm">
    <label for="bpmInput">Beats Per Minute (BPM):</label>
    <input type="number" id="bpmInput" value="180" min="1" max="500">
    <button type="submit">Update Speed</button>
  </form>
</div>



<script>
  let animationTimeout;
  let animationFadeout;

  // Функция для создания линии с текстом
  function createLineWithWords(words) {
    const lineContainer = document.getElementById('line');

    for (let i = 0; i < words.length; i++) {
      const cell = document.createElement('div');
      cell.className = 'line-item';
      cell.textContent = words[i];
      lineContainer.appendChild(cell);
    }
  }

  // Функция для подсветки ячеек поочередно
  function highlightCells(cells, currentIndex, interval, dilayTime, callback) {
    var startTime = performance.now();
    if (currentIndex < cells.length) {
      cells[currentIndex].classList.add('active');
      if( currentIndex != 0) {
        /*var audio = new Audio('tick.mp3');
        audio.play();*/
        dilayTime = 0;
      }

      animationFadeout = setTimeout(() => {
        cells[currentIndex].classList.remove('active');
      }, 70);

      var endTime = performance.now();
      //var dilayTime = endTime - startTime + dilayTime;
      console.log(interval-70-dilayTime)
      animationTimeout = setTimeout(() => {
        cells[currentIndex].classList.remove('active');
        highlightCells(cells, currentIndex + 1, interval, 0, callback);
      }, interval-70-dilayTime);
    } else {
      callback(); // Вызываем колбэк после завершения подсветки всех ячеек
    }
  }

  // Функция для обновления количества ячеек
  function updateCellCount(newCellCount, interval) {
    var startTime = performance.now();
    clearTimeout(animationTimeout); // Очищаем текущий таймаут, если он есть
    clearTimeout(animationFadeout);
    const lineContainer = document.getElementById('line');
    lineContainer.innerHTML = ''; // Очищаем текущие ячейки

    // Создаем новую линию с текстом
    const wordsArray = ['D', 'k', 'k', 'T', 'Як', 'Ду', 'Се', 'Чор', 'Панч'];
    const slicedWords = wordsArray.slice(0, newCellCount);
    createLineWithWords(slicedWords);

    // Запускаем подсветку новых ячеек
    const newCells = document.querySelectorAll('.line-item');
    var endTime = performance.now();
    var dilayTime = endTime - startTime;
    highlightCells(newCells, 0, interval, dilayTime, () => {
      // После завершения подсветки всех ячеек, меняем количество ячеек от 5 до 9
      const nextCellCount = Math.floor(Math.random() * 5) + 5;
      const nextInterval = interval; // Здесь вы можете изменить интервал для следующей анимации
      updateCellCount(nextCellCount, nextInterval);
    });
  }

  // Обработчик отправки формы
  document.getElementById('speedForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const bpmInput = document.getElementById('bpmInput');
    const newBPM = parseInt(bpmInput.value, 10);
    if (!isNaN(newBPM)) {
      const interval = 60000 / newBPM; // Преобразование BPM в интервал в миллисекундах
      updateCellCount(5, interval);
    }
  });

  function debug(interval) {
    item = document.querySelectorAll('.debug');
    //console.log(interval)
    var dilayTime = 0;
    flashingDebug = setInterval(() => {
        var startTime = performance.now();
        item[0].classList.add('active');
        setTimeout(() => {
          item[0].classList.remove('active');
        }, 70);
        var endTime = performance.now();
        dilayTime = endTime - startTime;
        console.log("X",interval-70-dilayTime)
      }, interval-70-dilayTime);

  }

  // Инициализация
  const initialCellCount = 5;
  const initialBPM = 180;
  const initialInterval = 60000 / initialBPM;
  console.log(initialInterval);
  updateCellCount(initialCellCount, initialInterval);
  debug(initialInterval);
</script>

</body>
</html>
